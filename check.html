<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Check - Seguimiento</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #0066cc; }
        h2 { color: #333; border-bottom: 2px solid #0066cc; padding-bottom: 10px; }
        .ok { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: #0066cc; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 5px; overflow-x: auto; }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #0052a3; }
        .secondary { background: #6c757d; }
        .secondary:hover { background: #5a6268; }
    </style>
</head>
<body>
    <div class="box">
        <h1>üîç Verificaci√≥n del Sistema</h1>
        <p>Esta p√°gina te dir√° exactamente qu√© versi√≥n tienes y qu√© est√° fallando.</p>
    </div>

    <div class="box">
        <h2>1. Archivos del Sistema</h2>
        <div id="files">Verificando...</div>
    </div>

    <div class="box">
        <h2>2. Autenticaci√≥n</h2>
        <div id="auth">Verificando...</div>
    </div>

    <div class="box">
        <h2>3. Men√∫ de Navegaci√≥n</h2>
        <div id="menu">Verificando...</div>
    </div>

    <div class="box">
        <h2>4. Acciones</h2>
        <button onclick="testLogin()">üîê Probar Login</button>
        <button onclick="clearAndReload()" class="secondary">üóëÔ∏è Limpiar Todo</button>
        <button onclick="location.href='index.html'">üè† Ir al Login</button>
        <div id="result" style="margin-top: 20px;"></div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        // 1. Verificar archivos
        const files = [
            'js/auth.js',
            'js/dashboard.js',
            'js/release-map.js',
            'js/storage.js',
            'js/app.js'
        ];

        let filesHtml = '<ul>';
        let allOk = true;

        Promise.all(files.map(file =>
            fetch(file).then(r => ({ file, ok: r.ok, status: r.status }))
        )).then(results => {
            results.forEach(r => {
                if (r.ok) {
                    filesHtml += `<li class="ok">‚úÖ ${r.file} - OK</li>`;
                } else {
                    filesHtml += `<li class="error">‚ùå ${r.file} - ERROR (${r.status})</li>`;
                    allOk = false;
                }
            });
            filesHtml += '</ul>';

            if (allOk) {
                filesHtml += '<p class="ok">‚úÖ Todos los archivos est√°n disponibles</p>';
            } else {
                filesHtml += '<p class="error">‚ùå Algunos archivos faltan - GitHub Pages puede no haberse actualizado</p>';
            }

            document.getElementById('files').innerHTML = filesHtml;
        });

        // 2. Verificar autenticaci√≥n
        setTimeout(() => {
            let authHtml = '';

            if (typeof authManager === 'undefined') {
                authHtml = '<p class="error">‚ùå AuthManager NO est√° cargado</p>';
                authHtml += '<p>El archivo js/auth.js no se carg√≥ correctamente</p>';
            } else {
                authHtml = '<p class="ok">‚úÖ AuthManager est√° cargado</p>';

                if (authManager.storageAvailable === false) {
                    authHtml += '<p class="error">‚ö†Ô∏è localStorage est√° BLOQUEADO (Safari Tracking Prevention)</p>';
                    authHtml += '<p class="info">üí° Soluci√≥n: Safari ‚Üí Preferencias ‚Üí Privacidad ‚Üí Desactivar "Prevent Cross-Site Tracking"</p>';
                } else {
                    authHtml += '<p class="ok">‚úÖ localStorage est√° disponible</p>';
                }

                const users = authManager.getAllUsers();
                authHtml += `<p>Usuarios en sistema: <strong>${users.length}</strong></p>`;

                if (users.length === 0) {
                    authHtml += '<p class="error">‚ùå NO hay usuarios creados</p>';
                } else {
                    authHtml += '<p class="ok">‚úÖ Usuarios disponibles:</p><ul>';
                    users.forEach(u => {
                        authHtml += `<li>${u.email} (${u.rol})</li>`;
                    });
                    authHtml += '</ul>';
                }
            }

            document.getElementById('auth').innerHTML = authHtml;
        }, 1000);

        // 3. Verificar men√∫
        fetch('index.html')
            .then(r => r.text())
            .then(html => {
                let menuHtml = '';

                const hasReleaseMap = html.includes('Mapa de Liberaciones');
                const hasCargarExcel = html.includes('Cargar Excel');
                const hasGestionarAccesos = html.includes('Gestionar Accesos');

                if (hasReleaseMap) {
                    menuHtml += '<p class="ok">‚úÖ "Mapa de Liberaciones" est√° en el c√≥digo</p>';
                } else {
                    menuHtml += '<p class="error">‚ùå "Mapa de Liberaciones" NO est√° en el c√≥digo</p>';
                    menuHtml += '<p class="info">Esto significa que GitHub Pages tiene una versi√≥n vieja</p>';
                }

                if (hasCargarExcel) menuHtml += '<p class="ok">‚úÖ "Cargar Excel" est√° en el c√≥digo</p>';
                if (hasGestionarAccesos) menuHtml += '<p class="ok">‚úÖ "Gestionar Accesos" est√° en el c√≥digo</p>';

                // Verificar versi√≥n del cache
                const match = html.match(/auth\.js\?v=(\w+)/);
                if (match) {
                    const version = match[1];
                    menuHtml += `<p class="info">üì¶ Versi√≥n del cache: <strong>${version}</strong></p>`;

                    if (version === '20250209e') {
                        menuHtml += '<p class="ok">‚úÖ Tienes la versi√≥n M√ÅS RECIENTE</p>';
                    } else {
                        menuHtml += '<p class="error">‚ö†Ô∏è Versi√≥n desactualizada (esperada: 20250209e)</p>';
                        menuHtml += '<p class="info">üí° Usa el bot√≥n "Limpiar Todo" abajo</p>';
                    }
                }

                document.getElementById('menu').innerHTML = menuHtml;
            });

        // Funciones de prueba
        function testLogin() {
            const result = document.getElementById('result');
            result.innerHTML = '<p class="info">‚è≥ Probando login...</p>';

            authManager.login('admin@seguimiento.com', 'Admin2024!')
                .then(r => {
                    if (r.success) {
                        result.innerHTML = '<p class="ok">‚úÖ ¬°LOGIN EXITOSO!</p><p>Puedes ir a <a href="index.html">index.html</a> y hacer login</p>';
                    } else {
                        result.innerHTML = `<p class="error">‚ùå Login fall√≥: ${r.message}</p>`;
                    }
                })
                .catch(err => {
                    result.innerHTML = `<p class="error">‚ùå Error: ${err.message}</p>`;
                });
        }

        function clearAndReload() {
            if (confirm('Esto borrar√° TODO (localStorage, cache) y recargar√°.\n\n¬øContinuar?')) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload(true);
            }
        }
    </script>
</body>
</html>
